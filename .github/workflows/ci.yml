name: Check and Build Firmware (CI)
on:
  push:
    branches:
      - main
      - develop
    tags-ignore:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
env:
  CARGO_TERM_COLOR: always
permissions:
  contents: read
jobs:
  lint:
    name: Formatting, linting, tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          components: rustfmt clippy
          targets: thumbv8m.main-none-eabihf
      - name: Run formatting check
        run: cargo fmt -- --check
      - name: Run clippy
        run: |
          cargo clippy --bin faderpunk --target thumbv8m.main-none-eabihf -- -D warnings
          cargo clippy -p libfp -- -D warnings
      - name: Run tests on libfp
        run: cargo test --lib -p libfp
  check-configurator:
    name: Generate bindings and build configurator
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22'
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
      - name: Setup rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
      - name: Install dependencies (configurator)
        run: pnpm install --frozen-lockfile
        working-directory: ./configurator
      - name: Generate postcard bindings (for configurator)
        run: ./gen-bindings.sh
      - name: Lint configurator
        run: pnpm run lint
        working-directory: ./configurator
      - name: Build configurator
        run: pnpm run build
        working-directory: ./configurator
  build_firmware_check:
    name: Build Firmware (Check)
    needs: [lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Install System Dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get clean && sudo apt-get update
          sudo apt-get install -y libudev-dev
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          targets: thumbv8m.main-none-eabihf
      - run: cargo install flip-link
      - run: cargo build --bin faderpunk --release --target thumbv8m.main-none-eabihf

name: Beta Release - firmware and configurator
on:
  push:
    branches:
      - develop
env:
  CARGO_TERM_COLOR: always
permissions:
  contents: write
  pull-requests: write
  issues: write
  pages: write
  id-token: write
jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      faderpunk_release_created: ${{ steps.release.outputs['faderpunk--release_created'] }}
      configurator_release_created: ${{ steps.release.outputs['configurator--release_created'] }}
      faderpunk_tag_name: ${{ steps.release.outputs['faderpunk--tag_name'] }}
      configurator_tag_name: ${{ steps.release.outputs['configurator--tag_name'] }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.beta.json
          manifest-file: .release-please-manifest.beta.json
          target-branch: develop
  build_picotool_for_release:
    name: Build Picotool for Release
    needs: release-please
    if: ${{ needs.release-please.outputs.faderpunk_release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential pkg-config libusb-1.0-0-dev cmake git
      - name: Clone pico-sdk repository
        run: git clone --branch master https://github.com/raspberrypi/pico-sdk.git
      - name: Clone picotool repository
        run: git clone --branch master https://github.com/raspberrypi/picotool.git
      - name: Get Git commit hashes for caching
        id: hashes
        run: |
          picotool_hash=$(git -C picotool rev-parse HEAD)
          pico_sdk_hash=$(git -C pico-sdk rev-parse HEAD)
          echo "picotool_hash=${picotool_hash}" >> $GITHUB_ENV
          echo "pico_sdk_hash=${pico_sdk_hash}" >> $GITHUB_ENV
      - name: Cache picotool build outputs
        uses: actions/cache@v4
        with:
          path: picotool/build
          key: ${{ runner.os }}-picotool-${{ env.picotool_hash }}-${{ env.pico_sdk_hash }}
      - name: Check if picotool already exists
        id: check_picotool
        run: |
          if [ -f picotool/build/picotool ]; then
            echo "picotool already exists. Skipping build."
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi
      - name: Initialize pico-sdk submodules
        if: steps.check_picotool.outputs.skip_build == 'false'
        run: |
          cd pico-sdk
          git submodule update --init lib/mbedtls
      - name: Set PICO_SDK_PATH
        if: steps.check_picotool.outputs.skip_build == 'false'
        run: echo "PICO_SDK_PATH=${{ github.workspace }}/pico-sdk" >> $GITHUB_ENV
      - name: Build picotool
        if: steps.check_picotool.outputs.skip_build == 'false'
        run: |
          cd picotool
          mkdir -p build
          cd build
          cmake ..
          make
      - name: Upload picotool artifact
        uses: actions/upload-artifact@v4
        with:
          name: picotool-artifact
          path: picotool/build/picotool
  build_firmware_for_release:
    name: Build Firmware for Release
    needs: release-please
    if: ${{ needs.release-please.outputs.faderpunk_release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Install System Dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get clean && sudo apt-get update
          sudo apt-get install -y libudev-dev
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          targets: thumbv8m.main-none-eabihf
      - run: cargo install flip-link
      - run: cargo build --bin faderpunk --release --target thumbv8m.main-none-eabihf
      - name: Upload firmware build artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-artifact
          path: target/thumbv8m.main-none-eabihf/release/faderpunk
  package_and_release_firmware:
    name: Package and Release Firmware
    needs: [release-please, build_firmware_for_release, build_picotool_for_release]
    if: ${{ needs.release-please.outputs.faderpunk_release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download picotool artifact
        uses: actions/download-artifact@v5
        with:
          name: picotool-artifact
          path: picotool_executable
      - name: Download firmware artifact
        uses: actions/download-artifact@v5
        with:
          name: firmware-artifact
          path: firmware_build
      - name: Prepare release files
        run: |
          mkdir -p release_files
          cp firmware_build/faderpunk release_files/faderpunk.elf
          chmod +x picotool_executable/picotool
          TAG_NAME="${{ needs.release-please.outputs.faderpunk_tag_name }}"
          picotool_executable/picotool uf2 convert release_files/faderpunk.elf release_files/${TAG_NAME}.uf2
      - name: Publish GitHub Release Artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.faderpunk_tag_name }}
          prerelease: true
          files: |
            release_files/faderpunk.elf
            release_files/${{ needs.release-please.outputs.faderpunk_tag_name }}.uf2
  build_configurator_for_release:
    name: Build Configurator for Release
    needs: release-please
    if: ${{ needs.release-please.outputs.configurator_release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22'
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
      - name: Setup rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
      - name: Install dependencies (configurator)
        run: pnpm install --frozen-lockfile
        working-directory: ./configurator
      - name: Generate postcard bindings (for configurator)
        run: ./gen-bindings.sh
      - name: Build configurator with beta base path
        run: pnpm run build
        working-directory: ./configurator
        env:
          BASE_URL: /beta/
          RELEASE_CHANNEL: beta
      - name: Create configurator release package
        run: |
          mkdir -p release_files
          cd configurator/dist
          zip -r ../../release_files/configurator.zip .
      - name: Upload configurator release artifact
        uses: actions/upload-artifact@v4
        with:
          name: configurator-release-artifact
          path: release_files/configurator.zip
      - name: Upload configurator artifact for GitHub Pages
        uses: actions/upload-artifact@v4
        with:
          name: configurator-pages-artifact
          path: 'configurator/dist'
  package_and_release_configurator:
    name: Package and Release Configurator
    needs: [release-please, build_configurator_for_release]
    if: ${{ needs.release-please.outputs.configurator_release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download configurator release artifact
        uses: actions/download-artifact@v5
        with:
          name: configurator-release-artifact
          path: configurator_build
      - name: Publish GitHub Release Artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.configurator_tag_name }}
          prerelease: true
          files: |
            configurator_build/configurator.zip
  deploy_configurator_to_pages:
    name: Deploy Configurator to GitHub Pages /beta
    needs: [release-please, build_configurator_for_release]
    if: ${{ needs.release-please.outputs.configurator_release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Check if gh-pages branch exists
        id: check_branch
        run: |
          if git ls-remote --heads origin gh-pages | grep gh-pages; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      - name: Create gh-pages branch if it doesn't exist
        if: steps.check_branch.outputs.exists == 'false'
        run: |
          git checkout --orphan gh-pages
          git rm -rf .
          echo "# Faderpunk Configurator" > README.md
          git add README.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Initialize gh-pages branch"
          git push origin gh-pages
      - name: Checkout gh-pages branch
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          path: gh-pages
      - name: Download configurator artifact
        uses: actions/download-artifact@v5
        with:
          name: configurator-pages-artifact
          path: configurator-dist
      - name: Deploy to /beta subfolder
        run: |
          mkdir -p gh-pages/beta
          rm -rf gh-pages/beta/*
          cp -r configurator-dist/* gh-pages/beta/
          # Remove CNAME from beta subdirectory (should only be at root)
          rm -f gh-pages/beta/CNAME
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add beta/
          git commit -m "Deploy beta configurator from ${{ needs.release-please.outputs.configurator_tag_name }}" || echo "No changes to commit"
          git push
